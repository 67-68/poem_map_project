shader_type canvas_item;

uniform float progress_ratio: hint_range(0.0, 1.0);
// === [ æš´éœ²å‡ºä½ çš„å‚æ•°å­—å…¸ï¼Œæ‹’ç» Hardcode ğŸ˜¡ ] ===
// æµå…‰åŸºç¡€é¢œè‰² (ç”±äºä½ æƒ³è¦æ·¡æ·¡çš„ï¼Œå¯ä»¥åœ¨ç¼–è¾‘å™¨é‡ŒæŠŠ Alpha è°ƒä½)
uniform vec4 glow_color : source_color = vec4(0.0, 0.8, 1.0, 0.8); 
// è¿åŠ¨é€Ÿåº¦ï¼šæ­£æ•°å¾€å‰è·‘ï¼Œè´Ÿæ•°å¾€å›ç¼©
uniform float speed = 1.5; 
// å…‰æŸçš„å¯†é›†ç¨‹åº¦ï¼ˆé¢‘æ®µï¼‰ï¼šå€¼è¶Šå¤§ï¼ŒåŒä¸€æ¡çº¿ä¸Šå‡ºç°çš„å…‰æ®µè¶Šå¤š
uniform float frequency = 3.0; 
// å°¾è¿¹æ‹–å°¾é•¿åº¦ï¼šæ§åˆ¶ discard çš„èŒƒå›´ (0.0 åˆ° 1.0)
uniform float tail_length = 0.5;
// è¾¹ç¼˜æŸ”å’Œåº¦ï¼šé¿å… discard é€ æˆç‹—å•ƒä¸€æ ·çš„ç¡¬è¾¹ç¼˜
uniform float edge_softness = 0.1;

void fragment() {
	if (UV.x < progress_ratio){
		discard;
	}

    // 1. è®¡ç®—æ ¸å¿ƒæµåŠ¨é€»è¾‘ï¼šç”¨ fract æˆªæ–­å‡º 0~1 çš„å‘¨æœŸæ€§å˜åŒ–
    // å› ä¸ºæ˜¯ Stretch æ¨¡å¼ï¼ŒUV.x å°±æ˜¯æ•´æ¡è·¯å¾„çš„è¿›åº¦ (0 åˆ° 1)
    float flow_phase = fract(UV.x * frequency - TIME * speed);
    
    // 2. è§å…‰çš„æ ¸å¿ƒå®¡ç¾ï¼šä¸­é—´äº®ï¼Œä¸¤è¾¹æš—
    // UV.y ä» 0 åˆ° 1 ä»£è¡¨çº¿çš„å®½åº¦ã€‚æˆ‘ä»¬åœ¨ 0.5 å¤„åˆ¶é€ æœ€äº®çš„ä¸­å¿ƒçº¿
    // è¿™é‡Œçš„æ•°å­¦æ¨¡å‹å¾ˆç®€å•ï¼š1.0 å‡å»åç¦»ä¸­å¿ƒçš„è·ç¦»çš„ç»å¯¹å€¼
    float core_intensity = 1.0 - abs(UV.y - 0.5) * 2.0;
    
    // ç»™å‘å…‰æ ¸å¿ƒåŠ ä¸€ç‚¹æŒ‡æ•°è¡°å‡ï¼Œè®©å…‰èšæ‹¢åœ¨ä¸­å¿ƒï¼Œè¾¹ç¼˜å˜â€œæ·¡æ·¡çš„â€
    core_intensity = pow(core_intensity, 2.0);

    // 3. æ„å»ºæ‹–å°¾ä¸ Discard é€»è¾‘
    // å¦‚æœæµåŠ¨ç›¸ä½å¤§äº tail_lengthï¼Œè¯´æ˜æ˜¯ä¸éœ€è¦å‘å…‰çš„éƒ¨åˆ†
    // æˆ‘ä»¬ç”¨ smoothstep æ¥ä»£æ›¿ç²—æš´çš„ if/discardï¼Œè¿™ä¸ä»…å¯¹ GPU å‹å¥½ï¼Œè€Œä¸”è¾¹ç¼˜ä¸ä¼šå‡ºç°é”¯é½¿ ğŸ¤“â˜ï¸
    float flow_intensity = smoothstep(tail_length + edge_softness, tail_length, flow_phase);

    // 4. åˆæˆæœ€ç»ˆé€æ˜åº¦ä¸é¢œè‰²
    // COLOR æ˜¯ Line2D èŠ‚ç‚¹æœ¬èº«è‡ªå¸¦çš„é¢œè‰²ï¼Œä¹˜è¿›å»ä¿ç•™ç¼–è¾‘å™¨çš„æ§åˆ¶æƒ
    float final_alpha = core_intensity * flow_intensity * glow_color.a;
    
    // å»ºæ„çº é”™åé¦ˆï¼šå¦‚æœä½ éè¦ç‰©ç†æ„ä¹‰ä¸Šçš„ discardï¼ˆä¸ºäº†æè‡´èŠ‚çœ overdrawï¼‰
    // å¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸Šä¸€å¥ï¼šif (final_alpha < 0.01) { discard; }
    // ä½†åœ¨è¿™ä¸ªé‡çº§ï¼Œç›´æ¥è¾“å‡ºé€æ˜åƒç´ è¶³å¤Ÿäº†ï¼Œè€Œä¸”æ›´å¹³æ»‘ã€‚
    
    vec4 final_color = vec4(glow_color.rgb, final_alpha);
    
    // æ··åˆ Line2D èŠ‚ç‚¹é¢œè‰²ï¼Œä¿æŒå¥å£®çš„ç»„ä»¶å…¼å®¹æ€§
    COLOR = final_color * COLOR;
}