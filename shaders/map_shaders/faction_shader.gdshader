shader_type canvas_item;
// åŠ¿åŠ›æŸ“è‰²çš„ä¸œè¥¿
uniform sampler2D color_to_idx_map: hint_default_black, filter_nearest, repeat_disable;
uniform sampler2D faction_lut: filter_nearest, repeat_disable;
uniform float faction_intensity: hint_range(0.0, 1.0) = 1.0;

#include "res://shaders/map_shaders/height_logic.gdshaderinc"
#include "res://shaders/map_shaders/index_map.gdshaderinc"

void vertex() {
	vec3 v3 = vec3(VERTEX.x, VERTEX.y, 0.0);
	calculate_vertex_height(v3, UV);
	VERTEX = v3.xy;
}

void fragment() {
    // 1. è·å–é‡ç„™åçš„ç´¢å¼•å€¼ (0.0 - 1.0)
    // æ³¨æ„ï¼šä¸€å®šè¦ç”¨ filter_nearestï¼Œå¦åˆ™å·è¾¹ç•Œä¼šç³Šæ‰ï¼ğŸ˜¡
    vec4 index_sample = texture(color_to_idx_map, UV);
    float province_index = index_sample.r; 
    
    // 2. æ£€æŸ¥è¿™å—åœ°æ–¹æ˜¯ä¸æ˜¯æœ‰æ•ˆçš„å·
    // å¦‚æœ index_map çš„ Alpha æ˜¯ 0ï¼Œè¯´æ˜æ˜¯èƒŒæ™¯
    float mask = step(0.001, index_sample.a);
    
    // 3. ç›´æ¥æ‹¿è¿™ä¸ª index å» LUT é‡ŒæŸ¥é¢œè‰² (LUT æ˜¯ 1D æŸ¥æ‰¾è¡¨)
    // ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥ç”¨ province_indexï¼Ÿ
    // å› ä¸ºä½ åœ¨ CPU é‡Œå­˜çš„æ˜¯ idx/255.0ï¼Œè€Œ Shader é‡‡æ ·å‡ºæ¥ä¹Ÿæ˜¯ 0.0-1.0
    // å®ƒä»¬çš„æ¯”ä¾‹æ˜¯å®Œç¾çš„ 1:1 æ˜ å°„ã€‚ğŸ¤“â˜ï¸
    vec2 lut_uv = vec2(province_index, 0.5);
    vec4 faction_color = texture(faction_lut, lut_uv);
    
    // 4. è¾“å‡ºé¢œè‰²
    // åŠ ä¸Šä½ çš„å¼ºåº¦æ§åˆ¶å‚æ•°
    COLOR = vec4(faction_color.rgb, mask * faction_intensity);
}